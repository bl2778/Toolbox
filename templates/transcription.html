<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audio Transcription - Analytics Toolbox</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <!-- Markdown rendering -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body>
    <div class="app-shell">
        <header class="app-header">
            <div class="container header-container">
                <a href="/dashboard" class="app-brand" aria-label="Bain Toolbox home">
                    <span class="app-brand-mark" aria-hidden="true">üîß</span>
                    <span class="app-brand-text">Bain Toolbox</span>
                </a>
                <nav class="app-nav" aria-label="Primary navigation">
                    <a href="/dashboard" class="nav-link">Dashboard</a>
                    <a href="/zd-tool" class="nav-link">Zero-Defect</a>
                    <a href="/wr" class="nav-link">Wording Revision</a>
                    <a href="/logout" class="nav-link logout-btn">Logout</a>
                </nav>
            </div>
        </header>

        <main class="app-main container">
        <!-- Header -->
        <header class="card page-header">
            <h1 class="title">Audio Transcription</h1>
            <p class="subtitle">Transform client interview recordings into professional transcripts with AI-powered precision</p>

            <div class="header-actions">
                <a href="/dashboard" class="btn btn-secondary btn-inline">Back to Dashboard</a>
            </div>
        </header>

        <!-- Upload Section -->
        <section class="card section-card">
            <h2 class="section-title">Upload Audio File</h2>

            <!-- File Upload Area -->
            <div class="file-upload-area" id="uploadArea">
                <div class="upload-text">
                    <strong>Drag & drop your audio file here</strong><br>
                    or <strong>click to select</strong>
                    <br><br>
                    <small>Supported formats: MP3, WAV, M4A, MP4, WEBM (Max: 300MB)</small>
                </div>
                <input type="file" id="fileInput" accept=".mp3,.wav,.m4a,.mp4,.mpeg,.mpga,.webm" style="display: none;">
            </div>

            <!-- File Information -->
                <div class="file-info" id="fileInfo" style="display: none;">
                <strong>Selected File:</strong> <span id="fileName"></span><br>
                <strong>Size:</strong> <span id="fileSize"></span><br>
                <strong>Type:</strong> <span id="fileType"></span>
            </div>

            <!-- Model Selection -->
            <div class="form-group">
                <label for="modelSelect" class="form-label">AI Model:</label>
                <select id="modelSelect" class="form-input">
                    <option value="gemini-2.5-pro">Gemini 2.5 Pro (Higher Quality)</option>
                    <option value="gemini-2.5-flash">Gemini 2.5 Flash (Faster Processing)</option>
                </select>
                <small class="form-hint">
                    Pro: Better accuracy for complex audio | Flash: Faster transcription speed
                </small>
            </div>

            <!-- Custom Prompt -->
            <div class="form-group">
                <label for="customPrompt" class="form-label">Custom Prompt (Optional):</label>
                <textarea id="customPrompt"
                          class="form-input"
                          rows="3"
                          placeholder="Leave empty to use default professional transcription prompt"></textarea>
            </div>

            <!-- Action Buttons -->
            <div class="action-row">
                <button type="button" class="btn btn-full" id="transcribeBtn" disabled>
                    Start Transcription
                </button>
                <button type="button" class="btn btn-secondary btn-inline" id="clearBtn" onclick="clearFile()">
                    Clear
                </button>
            </div>

            <!-- Progress Bar -->
            <div id="progressSection" class="progress-section" style="display: none;">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressBar"></div>
                </div>
                <div id="progressText" class="progress-copy">Processing...</div>
                <div id="progressPercent" class="progress-percent">0%</div>
            </div>
        </section>

        <!-- Results Section -->
        <section class="card section-card" id="resultsSection" style="display: none;">
            <h2 class="section-title">Transcription Results</h2>

            <div class="info-line">
                <strong>Prompt Used:</strong> <span id="promptUsed"></span>
            </div>

            <div class="transcription-result" id="transcriptionText"></div>

            <!-- Edit mode -->
            <div id="editMode" class="edit-mode" style="display: none;">
                <textarea id="editTextarea" class="form-input" rows="15"></textarea>
            </div>

            <div class="action-row action-row-center">
                <button type="button" class="btn" id="copyBtn" onclick="copyToClipboard()">
                    Copy to Clipboard
                </button>
                <button type="button" class="btn btn-secondary" id="editBtn" onclick="toggleEdit()">
                    Edit
                </button>
                <button type="button" class="btn" id="saveBtn" onclick="saveEdit()" style="display: none;">
                    Save
                </button>
                <button type="button" class="btn btn-secondary" id="cancelBtn" onclick="cancelEdit()" style="display: none;">
                    Cancel
                </button>
                <button type="button" class="btn" id="summaryBtn" onclick="startSummary()">
                    Auto Summary
                </button>
            </div>
        </section>

        <!-- Summary Section (Full Two Column Layout) -->
        <section id="summarySection" class="summary-section" style="display: none;">
            <!-- Back to Single Column Button at top -->
            <div class="header-actions">
                <button type="button" class="btn btn-secondary btn-inline" onclick="closeSummary()">
                    ‚Üê Back to Single Column View
                </button>
            </div>

            <div class="split-panel">
                <!-- Left Column: All Original Content -->
                <div class="panel">
                    <!-- Header -->
                    <div class="card page-header">
                        <h1 class="title">üé§ Audio Transcription</h1>
                        <p class="subtitle">Upload your client interview recordings for AI-powered transcription</p>
                    </div>

                    <!-- Upload Section (in summary mode) -->
                    <div class="card section-card" id="uploadSectionSummary" style="display: none;">
                        <h2 class="section-title">Upload Audio File</h2>
                        <div class="file-upload-area" id="uploadAreaSummary">
                            <div class="upload-text">
                                <strong>Drag & drop your audio file here</strong><br>
                                or <strong>click to select</strong>
                                <br><br>
                                <small>Supported formats: MP3, WAV, M4A, MP4, WEBM (Max: 300MB)</small>
                            </div>
                        </div>
                    </div>

                    <!-- Transcript Results in Summary Mode -->
                    <div class="card section-card">
                        <h2 class="section-title">Transcription Results</h2>
                        <div class="info-line">
                            <strong>Prompt Used:</strong> <span id="promptUsedSummary"></span>
                        </div>
                        <div class="transcription-result" id="originalTranscriptText"></div>
                    </div>
                </div>

                <!-- Right Column: Summary Panel -->
                <div class="panel">
                    <div class="card summary-panel">
                        <h2 class="section-title">AI Summary</h2>

                        <!-- Model Selection -->
                        <div class="form-group">
                            <label for="summaryModelSelect" class="form-label">AI Model:</label>
                            <select id="summaryModelSelect" class="form-input">
                                <option value="gpt-5" selected>GPT-5 (Latest)</option>
                                <option value="gpt-5-thinking">GPT-5 Thinking (Shows reasoning process)</option>
                            </select>
                            <small class="form-hint">
                                GPT-5 Thinking: Shows the AI's thought process with streaming output
                            </small>
                        </div>

                        <!-- Prompt Editor -->
                        <div class="form-group">
                            <label for="summaryPrompt" class="form-label">Summary Prompt:</label>
                            <textarea id="summaryPrompt"
                                      class="form-input"
                                      rows="6"
                                      placeholder="Loading default prompt...">You are a professional consultant, now helping a client with their project. You just had an interview, can you please summarize the key takeaways using professional consulting language. Please output in email-ready format with two sections: a) Executive Summary b) Details. The summary should exactly follow what was discussed in the transcript, please don't imagine.</textarea>
                            <small class="form-hint">
                                Note: The transcript will be automatically appended after your prompt.
                            </small>
                        </div>

                        <!-- Generate Button -->
                        <button type="button" class="btn btn-full" id="generateSummaryBtn" onclick="generateSummary()">
                            Generate Summary
                        </button>

                        <!-- Summary Progress -->
                        <div id="summaryProgress" class="summary-progress" style="display: none;">
                            <div class="callout">
                                <div id="summaryProgressText">ÂáÜÂ§áÁîüÊàêÊëòË¶Å...</div>
                            </div>
                        </div>

                        <!-- Thinking Process Section -->
                        <div id="thinkingSection" class="summary-stack" style="display: none;">
                            <button class="collapsible active" onclick="toggleThinking()">
                                <span>Thought Process</span>
                                <span id="thinkingToggleIcon" class="toggle-icon">‚ñº</span>
                            </button>
                            <div class="collapsible-content active" id="thinkingContent">
                                <div class="markdown-content markdown-panel" id="thinkingText"></div>
                            </div>
                        </div>

                        <!-- Final Summary Section -->
                        <div id="summaryResult" class="summary-stack" style="display: none;">
                            <button class="collapsible active" onclick="toggleAnswer()">
                                <span>Final Summary</span>
                                <span id="answerToggleIcon" class="toggle-icon">‚ñº</span>
                            </button>
                            <div class="collapsible-content active" id="answerContent">
                                <div class="markdown-content markdown-panel" id="answerText"></div>
                            </div>

                            <div class="action-row">
                                <button type="button" class="btn btn-secondary btn-flex" id="copyThinkingBtn" onclick="copyThinkingToClipboard()" style="display: none;">
                                    Copy Thinking
                                </button>
                                <button type="button" class="btn" onclick="copySummaryToClipboard()">
                                    Copy Summary
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Loading Section -->
        <div class="card loading" id="loadingSection" style="display: none;">
            <div class="spinner"></div>
            <p>Transcribing your audio file...</p>
            <p><small>This may take a few minutes depending on file size.</small></p>
        </div>
        </main>

        <footer class="app-footer">
            <div class="container footer">
                <p>¬© 2024 Bain Toolbox. All rights reserved.</p>
            </div>
        </footer>
    </div>

    <script>
        let selectedFile = null;

        // File upload area elements
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const fileInfo = document.getElementById('fileInfo');
        const transcribeBtn = document.getElementById('transcribeBtn');

        // Handle drag and drop
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        });

        // Handle click to select file
        uploadArea.addEventListener('click', () => {
            fileInput.click();
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFile(e.target.files[0]);
            }
        });

        function handleFile(file) {
            // Validate file type
            const allowedTypes = ['audio/mpeg', 'audio/mp3', 'audio/wav', 'audio/x-wav', 'audio/m4a', 'audio/mp4', 'video/mp4', 'audio/webm'];
            const allowedExtensions = ['.mp3', '.wav', '.m4a', '.mp4', '.mpeg', '.mpga', '.webm'];

            const fileExtension = '.' + file.name.split('.').pop().toLowerCase();
            if (!allowedTypes.includes(file.type) && !allowedExtensions.includes(fileExtension)) {
                alert('Please select a valid audio file (MP3, WAV, M4A, MP4, WEBM)');
                return;
            }

            // Validate file size (300MB)
            if (file.size > 300 * 1024 * 1024) {
                alert('File size must be less than 300MB');
                return;
            }

            selectedFile = file;

            // Update file info display
            document.getElementById('fileName').textContent = file.name;
            document.getElementById('fileSize').textContent = formatFileSize(file.size);
            document.getElementById('fileType').textContent = file.type || 'Unknown';

            fileInfo.style.display = 'block';
            transcribeBtn.disabled = false;

            // Update upload area appearance
            uploadArea.innerHTML = `
                <div class="upload-text">
                    <strong>File ready for transcription</strong><br>
                    <small>Click here to select a different file</small>
                </div>
                <input type="file" id="fileInput" accept=".mp3,.wav,.m4a,.mp4,.mpeg,.mpga,.webm" style="display: none;">
            `;

            // Re-attach event listener for new file input
            document.getElementById('fileInput').addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    handleFile(e.target.files[0]);
                }
            });
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function clearFile() {
            selectedFile = null;
            fileInfo.style.display = 'none';
            transcribeBtn.disabled = true;

            // Reset upload area
            uploadArea.innerHTML = `
                <div class="upload-text">
                    <strong>Drag & drop your audio file here</strong><br>
                    or <strong>click to select</strong>
                    <br><br>
                    <small>Supported formats: MP3, WAV, M4A, MP4, WEBM (Max: 300MB)</small>
                </div>
                <input type="file" id="fileInput" accept=".mp3,.wav,.m4a,.mp4,.mpeg,.mpga,.webm" style="display: none;">
            `;

            // Re-attach event listeners
            const newFileInput = document.getElementById('fileInput');
            newFileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    handleFile(e.target.files[0]);
                }
            });

            // Hide results and reset edit state
            document.getElementById('resultsSection').style.display = 'none';
            currentTaskId = null;
            if (isEditing) {
                cancelEdit();
            }
        }

        // Transcribe button click handler
        document.getElementById('transcribeBtn').addEventListener('click', async () => {
            if (!selectedFile) return;

            const customPrompt = document.getElementById('customPrompt').value.trim();
            const selectedModel = document.getElementById('modelSelect').value;

            // Show progress bar and hide loading/results
            document.getElementById('progressSection').style.display = 'block';
            document.getElementById('loadingSection').style.display = 'none';
            document.getElementById('resultsSection').style.display = 'none';
            transcribeBtn.disabled = true;

            let taskId = null;

            try {
                const formData = new FormData();
                formData.append('audio_file', selectedFile);
                if (customPrompt) {
                    formData.append('prompt', customPrompt);
                }
                formData.append('model', selectedModel);

                const response = await fetch('/api/transcribe', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (result.success) {
                    taskId = result.task_id;
                    currentTaskId = taskId;

                    // Show results
                    document.getElementById('promptUsed').textContent = result.prompt_used;
                    document.getElementById('transcriptionText').textContent = result.transcription;
                    document.getElementById('resultsSection').style.display = 'block';
                    document.getElementById('progressSection').style.display = 'none';
                } else {
                    // If we have a task ID, monitor its status
                    if (result.task_id) {
                        taskId = result.task_id;
                        monitorTranscriptionStatus(taskId);
                    } else {
                        alert('Transcription failed: ' + result.error);
                        document.getElementById('progressSection').style.display = 'none';
                    }
                }
            } catch (error) {
                alert('An error occurred: ' + error.message);
                document.getElementById('progressSection').style.display = 'none';
            } finally {
                if (!taskId) {
                    transcribeBtn.disabled = false;
                }
            }
        });

        // Function to monitor transcription status
        async function monitorTranscriptionStatus(taskId) {
            const maxAttempts = 300; // 10 minutes max (2 seconds interval)
            let attempts = 0;

            const checkStatus = async () => {
                try {
                    const response = await fetch(`/api/status/${taskId}`);
                    const status = await response.json();

                    console.log('Status update:', status); // Debug log

                    if (status.status === 'not_found') {
                        throw new Error('Task not found');
                    }

                    // Update progress bar
                    const progressBar = document.getElementById('progressBar');
                    const progressText = document.getElementById('progressText');
                    const progressPercent = document.getElementById('progressPercent');

                    progressBar.style.width = `${status.progress || 0}%`;
                    progressText.textContent = status.message || 'Processing...';
                    progressPercent.textContent = `${status.progress || 0}%`;

                    // Check if transcription is completed
                    if (status.status === 'completed') {
                        // Show results
                        currentTaskId = taskId;
                        document.getElementById('promptUsed').textContent = status.prompt_used;
                        document.getElementById('transcriptionText').textContent = status.transcription;
                        document.getElementById('resultsSection').style.display = 'block';
                        document.getElementById('progressSection').style.display = 'none';
                        transcribeBtn.disabled = false;

                        // Calculate processing time
                        if (status.total_time) {
                            console.log(`Transcription completed in ${Math.round(status.total_time)} seconds`);
                        }

                    } else if (status.status === 'failed' || status.status === 'timeout') {
                        alert('ËΩ¨ÂÜôÂ§±Ë¥•: ' + status.message);
                        document.getElementById('progressSection').style.display = 'none';
                        transcribeBtn.disabled = false;

                    } else {
                        // Continue monitoring for all other statuses (file_reading, file_uploaded, api_uploading, api_uploaded, processing, transcribing)
                        attempts++;
                        if (attempts < maxAttempts) {
                            setTimeout(checkStatus, 2000); // Check every 2 seconds
                        } else {
                            // Frontend timeout (shouldn't happen with backend timeout)
                            alert('ÂâçÁ´ØÁõëÊéßË∂ÖÊó∂ÔºåËØ∑Âà∑Êñ∞È°µÈù¢ÈáçËØï');
                            document.getElementById('progressSection').style.display = 'none';
                            transcribeBtn.disabled = false;
                        }
                    }

                } catch (error) {
                    console.error('Status check failed:', error);
                    attempts++;
                    if (attempts < maxAttempts) {
                        setTimeout(checkStatus, 2000);
                    } else {
                        alert('Êó†Ê≥ïËé∑ÂèñËΩ¨ÂÜôÁä∂ÊÄÅÔºåËØ∑Âà∑Êñ∞È°µÈù¢ÈáçËØï');
                        document.getElementById('progressSection').style.display = 'none';
                        transcribeBtn.disabled = false;
                    }
                }
            };

            // Start monitoring immediately
            setTimeout(checkStatus, 500); // First check after 500ms
        }

        // Edit functionality
        let currentTaskId = null;
        let isEditing = false;

        function toggleEdit() {
            const transcriptionText = document.getElementById('transcriptionText');
            const editMode = document.getElementById('editMode');
            const editTextarea = document.getElementById('editTextarea');
            const editBtn = document.getElementById('editBtn');
            const saveBtn = document.getElementById('saveBtn');
            const cancelBtn = document.getElementById('cancelBtn');

            if (!isEditing) {
                // Enter edit mode
                editTextarea.value = transcriptionText.textContent;
                transcriptionText.style.display = 'none';
                editMode.style.display = 'block';
                editBtn.style.display = 'none';
                saveBtn.style.display = 'inline-block';
                cancelBtn.style.display = 'inline-block';
                isEditing = true;
            }
        }

        function cancelEdit() {
            const transcriptionText = document.getElementById('transcriptionText');
            const editMode = document.getElementById('editMode');
            const editBtn = document.getElementById('editBtn');
            const saveBtn = document.getElementById('saveBtn');
            const cancelBtn = document.getElementById('cancelBtn');

            // Exit edit mode without saving
            transcriptionText.style.display = 'block';
            editMode.style.display = 'none';
            editBtn.style.display = 'inline-block';
            saveBtn.style.display = 'none';
            cancelBtn.style.display = 'none';
            isEditing = false;
        }

        async function saveEdit() {
            if (!currentTaskId) {
                alert('No transcription to save');
                return;
            }

            const editTextarea = document.getElementById('editTextarea');
            const editedText = editTextarea.value.trim();

            if (!editedText) {
                alert('Transcription cannot be empty');
                return;
            }

            try {
                const response = await fetch(`/api/edit/${currentTaskId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        edited_transcription: editedText
                    })
                });

                const result = await response.json();

                if (result.success) {
                    // Update the display
                    document.getElementById('transcriptionText').textContent = editedText;
                    cancelEdit(); // Exit edit mode

                    // Show success message
                    const saveBtn = document.getElementById('saveBtn');
                    const originalText = saveBtn.textContent;
                    saveBtn.textContent = 'Saved!';
                    setTimeout(() => {
                        saveBtn.textContent = originalText;
                    }, 2000);
                } else {
                    alert('Failed to save: ' + result.error);
                }
            } catch (error) {
                alert('An error occurred while saving: ' + error.message);
            }
        }

        function copyToClipboard() {
            let textToCopy;
            if (isEditing) {
                textToCopy = document.getElementById('editTextarea').value;
            } else {
                textToCopy = document.getElementById('transcriptionText').textContent;
            }

            navigator.clipboard.writeText(textToCopy).then(() => {
                const copyBtn = document.getElementById('copyBtn');
                const originalText = copyBtn.textContent;
                copyBtn.textContent = 'Copied!';
                copyBtn.style.background = '#27ae60';

                setTimeout(() => {
                    copyBtn.textContent = originalText;
                    copyBtn.style.background = '';
                }, 2000);
            }).catch(err => {
                alert('Failed to copy to clipboard');
            });
        }

        // Summary functionality
        let currentSummaryId = null;

        function startSummary() {
            if (!currentTaskId) {
                alert('No transcription available for summary');
                return;
            }

            // Get current transcript text
            let transcriptText;
            if (isEditing) {
                transcriptText = document.getElementById('editTextarea').value;
            } else {
                transcriptText = document.getElementById('transcriptionText').textContent;
            }

            // Get prompt used for transcription
            const promptUsed = document.getElementById('promptUsed').textContent;

            // Show summary section and hide all other sections
            document.getElementById('summarySection').style.display = 'block';
            document.getElementById('resultsSection').style.display = 'none';

            // Hide the main container content to switch to full-width layout
            const mainCards = document.querySelectorAll('.container > .card:not(#summarySection)');
            mainCards.forEach(card => {
                if (card.id !== 'summarySection') {
                    card.style.display = 'none';
                }
            });

            // Copy transcript and prompt to left column
            document.getElementById('originalTranscriptText').textContent = transcriptText;
            document.getElementById('promptUsedSummary').textContent = promptUsed;

            // Reset summary state
            document.getElementById('summaryResult').style.display = 'none';
            document.getElementById('thinkingSection').style.display = 'none';
            document.getElementById('summaryProgress').style.display = 'none';
            document.getElementById('generateSummaryBtn').disabled = false;
            currentSummaryId = null;

            // Reset button states
            document.getElementById('copyThinkingBtn').style.display = 'none';
            document.querySelector('#summaryResult .btn[onclick="copySummaryToClipboard()"]').style.width = '100%';
            document.querySelector('#summaryResult .btn[onclick="copySummaryToClipboard()"]').style.flex = 'none';

            // Make container wider for two-column layout
            document.querySelector('.container').style.maxWidth = '100%';
            document.querySelector('.container').style.width = '100%';
            document.querySelector('.container').style.padding = '20px';
        }

        function closeSummary() {
            // Hide summary section and show all original sections
            document.getElementById('summarySection').style.display = 'none';
            document.getElementById('resultsSection').style.display = 'block';

            // Show all hidden main container cards
            const mainCards = document.querySelectorAll('.container > .card:not(#summarySection)');
            mainCards.forEach(card => {
                if (card.id !== 'summarySection') {
                    card.style.display = 'block';
                }
            });

            // Restore original container width
            document.querySelector('.container').style.maxWidth = '900px';
            document.querySelector('.container').style.width = 'auto';
            document.querySelector('.container').style.padding = '20px';
        }

        async function generateSummary() {
            if (!currentTaskId) {
                alert('No transcription available');
                return;
            }

            const customPrompt = document.getElementById('summaryPrompt').value.trim();
            const selectedModel = document.getElementById('summaryModelSelect').value;

            // Show progress and disable button
            document.getElementById('summaryProgress').style.display = 'block';
            document.getElementById('summaryResult').style.display = 'none';
            document.getElementById('generateSummaryBtn').disabled = true;
            document.getElementById('summaryProgressText').textContent = 'Ê≠£Âú®ÂºÄÂßãÁîüÊàêÊëòË¶Å...';

            try {
                const response = await fetch('/api/summary', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        task_id: currentTaskId,
                        prompt: customPrompt,
                        model: selectedModel
                    })
                });

                const result = await response.json();

                if (result.success) {
                    currentSummaryId = result.summary_id;
                    monitorSummaryStatus(result.summary_id);
                } else {
                    alert('Summary generation failed: ' + result.error);
                    document.getElementById('summaryProgress').style.display = 'none';
                    document.getElementById('generateSummaryBtn').disabled = false;
                }

            } catch (error) {
                alert('An error occurred: ' + error.message);
                document.getElementById('summaryProgress').style.display = 'none';
                document.getElementById('generateSummaryBtn').disabled = false;
            }
        }

        // Variables to store thinking and answer content
        let currentThinking = "";
        let currentAnswer = "";
        let isThinkingMode = false;

        async function monitorSummaryStatus(summaryId) {
            const maxAttempts = 300; // 5 minutes max
            let attempts = 0;
            currentThinking = "";
            currentAnswer = "";
            isThinkingMode = false;

            const selectedModel = document.getElementById('summaryModelSelect').value;
            const isThinkingModelSelected = selectedModel === 'gpt-5-thinking';

            // Reset button states at the start
            document.getElementById('copyThinkingBtn').style.display = 'none';
            document.querySelector('#summaryResult .btn[onclick="copySummaryToClipboard()"]').style.width = '100%';
            document.querySelector('#summaryResult .btn[onclick="copySummaryToClipboard()"]').style.flex = 'none';

            const checkStatus = async () => {
                try {
                    const response = await fetch(`/api/summary/status/${summaryId}`);
                    const status = await response.json();

                    console.log('Summary status update:', status);

                    if (status.status === 'not_found') {
                        throw new Error('Summary task not found');
                    }

                    // Update progress text
                    document.getElementById('summaryProgressText').textContent = status.message || 'Â§ÑÁêÜ‰∏≠...';

                    // Show streaming content if available
                    if (status.partial_summary) {
                        // Parse thinking vs answer content
                        parseAndDisplayContent(status.partial_summary, isThinkingModelSelected);
                    }

                    // Check if completed
                    if (status.status === 'completed') {
                        // Parse final content
                        parseAndDisplayContent(status.summary, isThinkingModelSelected);

                        document.getElementById('summaryProgress').style.display = 'none';
                        document.getElementById('generateSummaryBtn').disabled = false;

                        // Auto-collapse thinking section after completion
                        if (isThinkingModelSelected && document.getElementById('thinkingSection').style.display !== 'none') {
                            setTimeout(() => {
                                collapseThinking();
                            }, 2000);
                        }

                        console.log(`Summary completed in ${Math.round(status.total_time)} seconds`);

                    } else if (status.status === 'failed') {
                        alert('ÊëòË¶ÅÁîüÊàêÂ§±Ë¥•: ' + status.message);
                        document.getElementById('summaryProgress').style.display = 'none';
                        document.getElementById('generateSummaryBtn').disabled = false;

                    } else {
                        // Continue monitoring
                        attempts++;
                        if (attempts < maxAttempts) {
                            setTimeout(checkStatus, 1000); // Check every 1 second
                        } else {
                            alert('ÊëòË¶ÅÁîüÊàêË∂ÖÊó∂ÔºåËØ∑ÈáçËØï');
                            document.getElementById('summaryProgress').style.display = 'none';
                            document.getElementById('generateSummaryBtn').disabled = false;
                        }
                    }

                } catch (error) {
                    console.error('Summary status check failed:', error);
                    attempts++;
                    if (attempts < maxAttempts) {
                        setTimeout(checkStatus, 2000);
                    } else {
                        alert('Êó†Ê≥ïËé∑ÂèñÊëòË¶ÅÁä∂ÊÄÅÔºåËØ∑ÈáçËØï');
                        document.getElementById('summaryProgress').style.display = 'none';
                        document.getElementById('generateSummaryBtn').disabled = false;
                    }
                }
            };

            // Start monitoring immediately
            setTimeout(checkStatus, 500);
        }

        function parseAndDisplayContent(content, isThinkingModel) {
            if (isThinkingModel) {
                // Parse GPT-5 thinking format
                const thinkingMatch = content.match(/<thinking>([\s\S]*?)<\/thinking>/);
                let thinking = thinkingMatch ? thinkingMatch[1].trim() : "";
                let answer = content.replace(/<thinking>[\s\S]*?<\/thinking>/, '').trim();

                // Update thinking section
                if (thinking && thinking !== currentThinking) {
                    currentThinking = thinking;
                    document.getElementById('thinkingSection').style.display = 'block';
                    document.getElementById('thinkingText').innerHTML = marked.parse(thinking);

                    // Show Copy Thinking button and adjust layout
                    document.getElementById('copyThinkingBtn').style.display = 'block';
                    document.querySelector('#summaryResult .btn[onclick="copySummaryToClipboard()"]').style.width = 'auto';
                    document.querySelector('#summaryResult .btn[onclick="copySummaryToClipboard()"]').style.flex = '1';
                }

                // Update answer section
                if (answer && answer !== currentAnswer) {
                    currentAnswer = answer;
                    document.getElementById('summaryResult').style.display = 'block';
                    document.getElementById('answerText').innerHTML = marked.parse(answer);
                }
            } else {
                // For non-thinking models, all content goes to answer
                if (content !== currentAnswer) {
                    currentAnswer = content;
                    document.getElementById('summaryResult').style.display = 'block';
                    document.getElementById('answerText').innerHTML = marked.parse(content);
                }
            }
        }

        // Toggle functions for collapsible sections
        function toggleThinking() {
            const content = document.getElementById('thinkingContent');
            const button = document.querySelector('#thinkingSection .collapsible');
            const icon = document.getElementById('thinkingToggleIcon');

            if (content.classList.contains('active')) {
                content.classList.remove('active');
                button.classList.remove('active');
                icon.textContent = '‚ñ∂';
            } else {
                content.classList.add('active');
                button.classList.add('active');
                icon.textContent = '‚ñº';
            }
        }

        function toggleAnswer() {
            const content = document.getElementById('answerContent');
            const button = document.querySelector('#answerSection .collapsible');
            const icon = document.getElementById('answerToggleIcon');

            if (content.classList.contains('active')) {
                content.classList.remove('active');
                button.classList.remove('active');
                icon.textContent = '‚ñ∂';
            } else {
                content.classList.add('active');
                button.classList.add('active');
                icon.textContent = '‚ñº';
            }
        }

        function collapseThinking() {
            const content = document.getElementById('thinkingContent');
            const button = document.querySelector('#thinkingSection .collapsible');
            const icon = document.getElementById('thinkingToggleIcon');

            if (content.classList.contains('active')) {
                content.classList.remove('active');
                button.classList.remove('active');
                icon.textContent = '‚ñ∂';
            }
        }

        function copyThinkingToClipboard() {
            const thinkingText = document.getElementById('thinkingText').textContent || currentThinking;

            if (!thinkingText) {
                alert('No thinking process available to copy');
                return;
            }

            navigator.clipboard.writeText(thinkingText).then(() => {
                const btn = event.target;
                const originalText = btn.textContent;
                btn.textContent = 'Copied!';

                setTimeout(() => {
                    btn.textContent = originalText;
                }, 2000);
            }).catch(err => {
                alert('Failed to copy thinking to clipboard');
            });
        }

        function copySummaryToClipboard() {
            const answerText = document.getElementById('answerText').textContent || currentAnswer;

            if (!answerText) {
                alert('No summary available to copy');
                return;
            }

            navigator.clipboard.writeText(answerText).then(() => {
                const btn = event.target;
                const originalText = btn.textContent;
                btn.textContent = 'Copied!';

                setTimeout(() => {
                    btn.textContent = originalText;
                }, 2000);
            }).catch(err => {
                alert('Failed to copy summary to clipboard');
            });
        }
    </script>
</body>
</html>
